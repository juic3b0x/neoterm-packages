neoterm_step_configure_cmake() {
	if [ "$NEOTERM_CMAKE_BUILD" = Ninja ]; then
		MAKE_PROGRAM_PATH=$(command -v ninja)
	else
		MAKE_PROGRAM_PATH=$(command -v make)
	fi
	BUILD_TYPE=Release
	test "$NEOTERM_DEBUG_BUILD" == "true" && BUILD_TYPE=Debug
	CMAKE_PROC=$NEOTERM_ARCH
	test $CMAKE_PROC == "arm" && CMAKE_PROC='armv7-a'

	local CMAKE_NEOTERM_TOOL_C_COMPILER=False
	if [ "$NEOTERM_PKG_ENABLE_CLANG16_PORTING" = "true" ]; then
		local _cc
		if _cc="$(command -v ${CC-})"; then
			CMAKE_NEOTERM_TOOL_C_COMPILER="$_cc"
		fi
	fi

	local CMAKE_ADDITIONAL_ARGS=()
	if [ "$NEOTERM_ON_DEVICE_BUILD" = "false" ]; then
 		if [ "$NEOTERM_PACKAGE_LIBRARY" = "bionic" ]; then
			CXXFLAGS+=" --target=$CCNEOTERM_HOST_PLATFORM"
			CFLAGS+=" --target=$CCNEOTERM_HOST_PLATFORM"
			LDFLAGS+=" --target=$CCNEOTERM_HOST_PLATFORM"
   		fi

		CMAKE_ADDITIONAL_ARGS+=("-DCMAKE_CROSSCOMPILING=$(test \"${NEOTERM_PKG_CMAKE_CROSSCOMPILING}\" = \"true\" && echo True || echo False)")
		CMAKE_ADDITIONAL_ARGS+=("-DCMAKE_LINKER=$NEOTERM_STANDALONE_TOOLCHAIN/bin/$LD $LDFLAGS")
  		if [ "$NEOTERM_PACKAGE_LIBRARY" = "bionic" ]; then
			CMAKE_ADDITIONAL_ARGS+=("-DCMAKE_SYSTEM_NAME=Android")
			CMAKE_ADDITIONAL_ARGS+=("-DCMAKE_SYSTEM_VERSION=$NEOTERM_PKG_API_LEVEL")
			CMAKE_ADDITIONAL_ARGS+=("-DCMAKE_NEOTERM_TOOL_C_COMPILER=$CMAKE_NEOTERM_TOOL_C_COMPILER")
			CMAKE_ADDITIONAL_ARGS+=("-DCMAKE_ANDROID_STANDALONE_TOOLCHAIN=$NEOTERM_STANDALONE_TOOLCHAIN")
   		elif [ "$NEOTERM_PACKAGE_LIBRARY" = "glibc" ]; then
     			CMAKE_ADDITIONAL_ARGS+=("-DCMAKE_SYSTEM_NAME=Linux")
			CMAKE_ADDITIONAL_ARGS+=("-DCMAKE_NEOTERM_TOOL_C_COMPILER=$CC")
  		fi
  		CMAKE_ADDITIONAL_ARGS+=("-DCMAKE_SYSTEM_PROCESSOR=$CMAKE_PROC")
	else
		CMAKE_ADDITIONAL_ARGS+=("-DCMAKE_LINKER=$(command -v $LD) $LDFLAGS")
	fi

	# XXX: CMAKE_{AR,RANLIB} needed for at least jsoncpp build to not
	# pick up cross compiled binutils tool in $NEOTERM_PREFIX/bin:
	cmake -G "$NEOTERM_CMAKE_BUILD" "$NEOTERM_PKG_SRCDIR" \
		-DCMAKE_AR="$(command -v $AR)" \
		-DCMAKE_UNAME="$(command -v uname)" \
		-DCMAKE_RANLIB="$(command -v $RANLIB)" \
		-DCMAKE_STRIP="$(command -v $STRIP)" \
		-DCMAKE_BUILD_TYPE=$BUILD_TYPE \
		-DCMAKE_C_FLAGS="$CFLAGS $CPPFLAGS" \
		-DCMAKE_CXX_FLAGS="$CXXFLAGS $CPPFLAGS" \
		-DCMAKE_FIND_ROOT_PATH=$NEOTERM_PREFIX \
		-DCMAKE_FIND_ROOT_PATH_MODE_PROGRAM=NEVER \
		-DCMAKE_FIND_ROOT_PATH_MODE_INCLUDE=ONLY \
		-DCMAKE_FIND_ROOT_PATH_MODE_LIBRARY=ONLY \
		-DCMAKE_INSTALL_PREFIX=$NEOTERM_PREFIX \
		-DCMAKE_INSTALL_LIBDIR=$NEOTERM_PREFIX/lib \
		-DCMAKE_MAKE_PROGRAM=$MAKE_PROGRAM_PATH \
		-DCMAKE_SKIP_INSTALL_RPATH=ON \
		-DCMAKE_USE_SYSTEM_LIBRARIES=True \
		-DDOXYGEN_EXECUTABLE= \
		-DBUILD_TESTING=OFF \
		"${CMAKE_ADDITIONAL_ARGS[@]}" \
		$NEOTERM_PKG_EXTRA_CONFIGURE_ARGS \
		|| (neoterm_step_configure_cmake_failure_hook && false)
}

neoterm_step_configure_cmake_failure_hook() {
	false
}
